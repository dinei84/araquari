<!-- adicionar_carregamento.html -->
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listagem de Carregamentos</title>
    <link rel="stylesheet" href="css/lista_carregamento.css">
    <link rel="stylesheet" href="../../menu.css">
    <link rel="shortcut icon" href="../../assets/favcom.png" type="image/x-icon">

</head>
<body>

    <nav class="sidebar">
        <div class="hamburger-menu">
            <div class="hamburger"></div>
        </div>
        <ul class="nav-list">
            <li>
                <a href="lista_fretes.html">
                    <i class="fas fa-table"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M620-163 450-333l56-56 114 114 226-226 56 56-282 282Zm220-397h-80v-200h-80v120H280v-120h-80v560h240v80H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h167q11-35 43-57.5t70-22.5q40 0 71.5 22.5T594-840h166q33 0 56.5 23.5T840-760v200ZM480-760q17 0 28.5-11.5T520-800q0-17-11.5-28.5T480-840q-17 0-28.5 11.5T440-800q0 17 11.5 28.5T480-760Z" />
                        </svg></i>
                    <span>Planilha</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-truck"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q146 0 255.5 91.5T872-559h-82q-19-73-68.5-130.5T600-776v16q0 33-23.5 56.5T520-680h-80v80q0 17-11.5 28.5T400-560h-80v80h80v120h-40L168-552q-3 18-5.5 36t-2.5 36q0 131 92 225t228 95v80Zm364-20L716-228q-21 12-45 20t-51 8q-75 0-127.5-52.5T440-380q0-75 52.5-127.5T620-560q75 0 127.5 52.5T800-380q0 27-8 51t-20 45l128 128-56 56ZM620-280q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Z" />
                        </svg></i>
                    <span>Consulta de Frete</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-comments"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z" />
                        </svg></i>
                    <span>Chat</span>
                </a>
            </li>
            <li>
                <a href="../CALCULADORAS/calculadoras.html">
                    <i class="fas fa-calculator"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M320-240h60v-80h80v-60h-80v-80h-60v80h-80v60h80v80Zm200-30h200v-60H520v60Zm0-100h200v-60H520v60Zm44-152 56-56 56 56 42-42-56-58 56-56-42-42-56 56-56-56-42 42 56 56-56 58 42 42Zm-314-70h200v-60H250v60Zm-50 472q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z" />
                        </svg></i>
                    <span>Calculadoras</span>
                </a>
            </li>
            <li>
                <a href="../OC/oc.html">
                    <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="white">
                            <path
                                d="M280-280h84l240-238-86-86-238 238v86Zm352-266 42-44q6-6 6-14t-6-14l-56-56q-6-6-14-6t-14 6l-44 42 86 86ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm280-590q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-200v-560 560Z" />
                        </svg></i>
                    <span>Ordens Manuais</span>
                </a>
            </li>
            <li>
                <a href="../CONTATOS/contato.html">
                    <i class="fas fa-address-book"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                            viewBox="0 -960 960 960" width="24px" fill="#FFFFFF">
                            <path
                                d="M80-120q-33 0-56.5-23.5T0-200v-560q0-33 23.5-56.5T80-840h800q33 0 56.5 23.5T960-760v560q0 33-23.5 56.5T880-120H80Zm556-80h244v-560H80v560h4q42-75 116-117.5T360-360q86 0 160 42.5T636-200ZM360-400q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm400 160 80-80-60-80h-66q-6-18-10-38.5t-4-41.5q0-21 4-40.5t10-39.5h66l60-80-80-80q-54 42-87 106.5T640-480q0 69 33 133.5T760-240Zm-578 40h356q-34-38-80.5-59T360-280q-51 0-97 21t-81 59Zm178-280q-17 0-28.5-11.5T320-520q0-17 11.5-28.5T360-560q17 0 28.5 11.5T400-520q0 17-11.5 28.5T360-480Zm120 0Z" />
                        </svg></i>
                    <span>Lista de Contatos</span>
                </a>
            </li>
            <li>
                <a href="../MOSTRADOR/index1.html">
                    <i class="fas fa-tv"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960"
                            width="30px" fill="#FFFFFF">
                            <path
                                d="M120-120q-33 0-56.5-23.5T40-200v-480q0-33 23.5-56.5T120-760h720q33 0 56.5 23.5T920-680v480q0 33-23.5 56.5T840-120H120Zm0-80h720v-480H120v480Zm160 160v-80h400v80H280Z" />
                        </svg></i>
                    <span>Televisão</span>
                </a>
            </li>
  
            <li>
                <a href="../TRACKING/indextracking.html">
                    <i class="fas fa-truck"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q146 0 255.5 91.5T872-559h-82q-19-73-68.5-130.5T600-776v16q0 33-23.5 56.5T520-680h-80v80q0 17-11.5 28.5T400-560h-80v80h80v120h-40L168-552q-3 18-5.5 36t-2.5 36q0 131 92 225t228 95v80Zm364-20L716-228q-21 12-45 20t-51 8q-75 0-127.5-52.5T440-380q0-75 52.5-127.5T620-560q75 0 127.5 52.5T800-380q0 27-8 51t-20 45l128 128-56 56ZM620-280q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Z" />
                        </svg></i>
                    <span>Tracking</span>
                </a>
            </li>
  
            <li>
                <a href="../../index.html">
                    <i class="fas fa-home"><svg xmlns="http://www.w3.org/2000/svg" height="30px"
                            viewBox="0 -960 960 960" width="30px" fill="#FFFFFF">
                            <path
                                d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" />
                        </svg></i>
                    <span>Início</span>
                </a>
            </li>
  
        </ul>
    </nav>

    <div class="container">
        <h1>Listagem de Carregamentos</h1>

        <a href="lista_fretes.html" class="btn-voltar-fretes">Voltar para Lista de Fretes</a>
        <a href="#" id="btnNovoCarregamento" class="btn-novo-carregamento">Novo Carregamento</a>        
        <button onclick="captureAndDownload()" class="btn-share">Imprimir / Baixar</button>

        <div>
            <table id="tabelaFretes">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Expedidor (ARMAZEM)</th>
                        <th>Destinatario</th>
                        <th>Recebedor</th>
                        <th>Cidade Troca de NFe</th>
                        <th>Destino Final</th>
                        <th>Produto</th>
                        <th>Embalagem</th>
                        <th>Liberado</th>
                        <th>Marcado</th>
                        <th>Saldo</th>
                        <th>Frete Empresa</th>
                        <th>Frete Motorista</th>
                        <th>Pedido</th>
                        <th>Operação</th>
                        <th>Lote</th>
                        <th>Observações</th>
                    </tr>
                </thead>
            </table>
        </div>

        <table id="tabelaCarregamentos">
            <thead>
                <tr>
                    <th>Data OC</th>
                    <th>Placa</th>
                    <th>Motorista</th>
                    <th>Tipo de Veiculo</th>
                    <th>Peso Carregado</th>
                    <th>Frete Motorista</th>
                    <th>Emissor</th>
                    <th>Data do Manifesto</th>
                    <th>CTe</th>
                    <th>Data de Entrega</th>
                    <th>NFe</th>
                    <th>Observação</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="corpoTabelaCarregamentos">

            </tbody>
        </table>
    </div>

    <script src="../../menu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            deleteDoc,
            getDoc,
            increment,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcpggR7jf2BEPNLqRj1Iz368F0dDtD1-4",
            authDomain: "planilha-8938f.firebaseapp.com",
            projectId: "planilha-8938f",
            storageBucket: "planilha-8938f.firebasestorage.app",
            messagingSenderId: "211015132743",
            appId: "1:211015132743:web:45f443dc9e65b72fe37362"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const freteId = urlParams.get('freteId');

        if (!freteId) {
            alert('Frete ID não encontrado!');
            // Optionally redirect back to frete list
            window.location.href = 'lista_fretes.html';
        }

        function formatNumber(number) {
            return number.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function parseFormattedNumber(str) {
            // Primeiro remove pontos de milhar, depois substitui vírgula decimal por ponto
            return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        }

        document.getElementById('btnNovoCarregamento').href = `adicionar_carregamento.html?freteId=${freteId}`;


        async function carregarCarregamentos() {
            try {
                // Carrega informações do frete específico
                const freteDoc = await getDoc(doc(db, 'fretes', freteId));
                if (freteDoc.exists()) {
                    const freteData = freteDoc.data();

                    // Limpa os dados anteriores, mantendo o cabeçalho
                    const tabelaFretes = document.getElementById('tabelaFretes');
                    const cabecalhoFretes = tabelaFretes.querySelector('thead');
                    tabelaFretes.innerHTML = '';
                    tabelaFretes.appendChild(cabecalhoFretes);

                    // Cria corpo da tabela e adiciona os dados do frete
                    const corpoFretes = document.createElement('tbody');
                    corpoFretes.id = 'corpoTabelaFretes';
                    const linhaFrete = `
                <tr>
                    <td>${freteData.cliente || 'N/A'}</td>
                    <td>${freteData.expedidor || 'N/A'}</td>
                    <td>${freteData.destinatario || 'N/A'}</td>
                    <td>${freteData.recebedor || 'N/A'}</td>
                    <td>${freteData.destinotroca || 'N/A'}</td>
                    <td>${freteData.destino || 'N/A'}</td>
                    <td>${freteData.produto || 'N/A'}</td>
                    <td>${freteData.embalagem || 'N/A'}</td>
                    <td>${freteData.liberado || 'N/A'}</td>
                    <td>${freteData.marcado || 'N/A'}</td>
                    <td>${freteData.saldo || 'N/A'}</td>
                    <td>${freteData.frempresa || 'N/A'}</td>
                    <td>${freteData.motorista || 'N/A'}</td>
                    <td>${freteData.pedido || 'N/A'}</td>
                    <td>${freteData.operacao || 'N/A'}</td>
                    <td>${freteData.lote || 'N/A'}</td>
                    <td>${freteData.observacoes || 'N/A'}</td>
                </tr>
            `;
                    corpoFretes.innerHTML = linhaFrete;
                    tabelaFretes.appendChild(corpoFretes);
                } else {
                    console.error('Frete não encontrado!');
                    alert('Frete não encontrado!');
                }

                // Carrega os carregamentos relacionados
                const querySnapshot = await getDocs(collection(db, 'fretes', freteId, 'carregamentos'));
                const corpoTabelaCarregamentos = document.getElementById('corpoTabelaCarregamentos');
                corpoTabelaCarregamentos.innerHTML = '';

                if (querySnapshot.empty) {
                    console.log('Nenhum carregamento encontrado para este frete.');
                    corpoTabelaCarregamentos.innerHTML = 'Ainda nenhum Carregamento cadastrado para este Frete.';
                } else {
                    querySnapshot.forEach((doc) => {
                        const carregamento = doc.data();
                        const linha = `
                    <tr>
                        <td>${carregamento.dataoc || 'N/A'}</td>
                        <td>${carregamento.placa || 'N/A'}</td>
                        <td>${carregamento.motorista || 'N/A'}</td>
                        <td>${carregamento['tipo-veiculo'] || 'N/A'}</td>
                        <td>${formatNumber(carregamento['peso-carregado'] || 'N/A')}</td>
                        <td>${carregamento.fretemotorista || 'N/A'}</td>
                        <td>${carregamento.emissor || 'N/A'}</td>
                        <td>${carregamento['data-manifesto'] || 'N/A'}</td>
                        <td>${carregamento.cte || 'N/A'}</td>
                        <td>${carregamento['data-entrega'] || 'N/A'}</td>
                        <td>${carregamento.nfe || 'N/A'}</td>
                        <td>${carregamento.observacao || 'N/A'}</td>
                        <td class="acoes">
                            <button class="btn-editar" onclick="editarCarregamento('${doc.id}')">Editar</button>
                            <button class="btn-excluir" onclick="excluirCarregamento('${doc.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
                        corpoTabelaCarregamentos.innerHTML += linha;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Verifique o console para mais detalhes.');
            }
        }

        window.editarCarregamento = (carregamentoId) => {
    window.location.href = `adicionar_carregamento.html?freteId=${freteId}&carregamentoId=${carregamentoId}`;
}

        window.excluirCarregamento = async (carregamentoId) => {
            if (confirm('Tem certeza que deseja excluir este carregamento permanentemente?')) {
                try {
                    const carregamentoRef = doc(db, 'fretes', freteId, 'carregamentos', carregamentoId);
                    const carregamentoSnap = await getDoc(carregamentoRef);
                    const peso = carregamentoSnap.data()['peso-carregado'];

                    // Atualizar frete
                    const freteRef = doc(db, 'fretes', freteId);
                    await updateDoc(freteRef, {
                        carregado: increment(-peso),
                        saldo: increment(peso)
                    });

                    await deleteDoc(carregamentoRef);
                    carregarCarregamentos();
                    alert('Carregamento excluído com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir carregamento:', error);
                }
            }
        };

        // Regex for number input validation
        const numberPattern = /^[0-9]+(\.[0-9]{1,2})?$/; // Allows up to two decimal places

        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function (e) {
                if (!numberPattern.test(this.value)) {
                    this.value = this.value.slice(0, -1); // Remove the last character if invalid
                }
            });
        });

        // Substitua a função window.captureAndShare por esta versão melhorada
        window.captureAndDownload = async () => {
    try {
        alert('Preparando para captura...');

        // Elementos a serem ocultados
        const elementsToHide = [
            document.getElementById('btnNovoCarregamento'),
            document.getElementById('btn-voltar-fretes'),
            document.querySelector('button[onclick="captureAndDownload()"]'),
            ...document.querySelectorAll('.acoes') // Coluna de ações
        ];

        // Ocultar elementos
        elementsToHide.forEach(element => {
            if(element) element.classList.add('hide-for-print');
        });

        // Configurações do html2canvas
        const options = {
            scale: 2,
            logging: true,
            useCORS: true,
            scrollY: -window.scrollY,
            onclone: (clonedDoc) => {
                // Garantir que elementos permaneçam ocultos no clone
                clonedDoc.querySelectorAll('.hide-for-print').forEach(element => {
                    element.style.display = 'none';
                });
            }
        };

        const container = document.querySelector('.container');
        const canvas = await html2canvas(container, options);
        const dataUrl = canvas.toDataURL('image/png', 1.0);

        // Criar e disparar download
        const link = document.createElement('a');
        link.download = `Carregamentos_${freteId}_${new Date().toISOString().slice(0,10)}.png`;
        link.href = dataUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Restaurar elementos
        elementsToHide.forEach(element => {
            if(element) element.classList.remove('hide-for-print');
        });

        alert('Imagem gerada com sucesso!');

    } catch (error) {
        console.error('Erro na captura:', error);
        alert('Falha ao gerar imagem');
    }
};


        // Carrega os carregamentos quando a página é aberta
        carregarCarregamentos();
    </script>
</body>

</html>