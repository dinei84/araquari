<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoramento de Cargas</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="../../menu.css">
</head>
<body>

    <nav class="sidebar">
        <div class="hamburger-menu">
            <div class="hamburger"></div>
        </div>
        <ul class="nav-list">
            <li>
                <a href="#">
                    <i class="fas fa-table"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M620-163 450-333l56-56 114 114 226-226 56 56-282 282Zm220-397h-80v-200h-80v120H280v-120h-80v560h240v80H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h167q11-35 43-57.5t70-22.5q40 0 71.5 22.5T594-840h166q33 0 56.5 23.5T840-760v200ZM480-760q17 0 28.5-11.5T520-800q0-17-11.5-28.5T480-840q-17 0-28.5 11.5T440-800q0 17 11.5 28.5T480-760Z"/></svg></i>
                    <span>Planilha</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-truck"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q146 0 255.5 91.5T872-559h-82q-19-73-68.5-130.5T600-776v16q0 33-23.5 56.5T520-680h-80v80q0 17-11.5 28.5T400-560h-80v80h80v120h-40L168-552q-3 18-5.5 36t-2.5 36q0 131 92 225t228 95v80Zm364-20L716-228q-21 12-45 20t-51 8q-75 0-127.5-52.5T440-380q0-75 52.5-127.5T620-560q75 0 127.5 52.5T800-380q0 27-8 51t-20 45l128 128-56 56ZM620-280q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Z"/></svg></i>
                    <span>Consulta de Frete</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-comments"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg></i>
                    <span>Chat</span>
                </a>
            </li>
            <li>
                <a href="../CALCULADORAS/calculadoras.html">
                    <i class="fas fa-calculator"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M320-240h60v-80h80v-60h-80v-80h-60v80h-80v60h80v80Zm200-30h200v-60H520v60Zm0-100h200v-60H520v60Zm44-152 56-56 56 56 42-42-56-58 56-56-42-42-56 56-56-56-42 42 56 56-56 58 42 42Zm-314-70h200v-60H250v60Zm-50 472q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z"/></svg></i>
                    <span>Calculadoras</span>
                </a>
            </li>
            <li>
                <a href="../OC/oc.html">
                    <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="white"><path d="M280-280h84l240-238-86-86-238 238v86Zm352-266 42-44q6-6 6-14t-6-14l-56-56q-6-6-14-6t-14 6l-44 42 86 86ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm280-590q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-200v-560 560Z"/></svg></i>
                    <span>Ordens Manuais</span>
                </a>
            </li>
            <li>
                <a href="../CONTATOS/contato.html">
                    <i class="fas fa-address-book"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M80-120q-33 0-56.5-23.5T0-200v-560q0-33 23.5-56.5T80-840h800q33 0 56.5 23.5T960-760v560q0 33-23.5 56.5T880-120H80Zm556-80h244v-560H80v560h4q42-75 116-117.5T360-360q86 0 160 42.5T636-200ZM360-400q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm400 160 80-80-60-80h-66q-6-18-10-38.5t-4-41.5q0-21 4-40.5t10-39.5h66l60-80-80-80q-54 42-87 106.5T640-480q0 69 33 133.5T760-240Zm-578 40h356q-34-38-80.5-59T360-280q-51 0-97 21t-81 59Zm178-280q-17 0-28.5-11.5T320-520q0-17 11.5-28.5T360-560q17 0 28.5 11.5T400-520q0 17-11.5 28.5T360-480Zm120 0Z"/></svg></i>
                    <span>Lista de Contatos</span>
                </a>
            </li>
            <li>
                <a href="../MOSTRADOR/index1.html">
                    <i class="fas fa-tv"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M120-120q-33 0-56.5-23.5T40-200v-480q0-33 23.5-56.5T120-760h720q33 0 56.5 23.5T920-680v480q0 33-23.5 56.5T840-120H120Zm0-80h720v-480H120v480Zm160 160v-80h400v80H280Z"/></svg></i>
                    <span>Televisão</span>
                </a>
            </li>

            <li>
                <a href="indextracking.html">
                    <i class="fas fa-truck"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q146 0 255.5 91.5T872-559h-82q-19-73-68.5-130.5T600-776v16q0 33-23.5 56.5T520-680h-80v80q0 17-11.5 28.5T400-560h-80v80h80v120h-40L168-552q-3 18-5.5 36t-2.5 36q0 131 92 225t228 95v80Zm364-20L716-228q-21 12-45 20t-51 8q-75 0-127.5-52.5T440-380q0-75 52.5-127.5T620-560q75 0 127.5 52.5T800-380q0 27-8 51t-20 45l128 128-56 56ZM620-280q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Z"/></svg></i>
                    <span>Tracking</span>
                </a>
            </li>

            <li>
                <a href="../../index.html">
                    <i class="fas fa-home"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#FFFFFF"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg></i>
                    <span>Início</span>
                </a>
            </li>            
            
        </ul>
    </nav>


  <div>
      <h1>Monitoramento de Cargas</h1>
  </div>
  <div>
      <button onclick="window.location.href='cadastro.html'">Adicionar Carga</button>
      <button onclick="captureAndDownload()">Imprimir / Baixar Snapshot</button>
      <button onclick="captureAndShare()">Compartilhar no WhatsApp</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Emissão NF</th>
        <th>Placa</th>
        <th>Localização Atual</th>
        <th>Observação</th>
        <th>Mercadoria</th>
        <th>Nº Nota</th>
        <th>Nº Conhecimento</th>
        <th>Previsão de Entrega</th>
        <th>Telefone</th>
        <th>Motorista</th>
        <th>Comentario</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="cargas-lista"></tbody>
  </table>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcpggR7jf2BEPNLqRj1Iz368F0dDtD1-4",
      authDomain: "planilha-8938f.firebaseapp.com",
      projectId: "planilha-8938f",
      storageBucket: "planilha-8938f.appspot.com",
      messagingSenderId: "211015132743",
      appId: "1:211015132743:web:45f443dc9e65b72fe37362"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const traelCollection = collection(db, "trael");

    async function carregarCarregamentos() {
      try {
        const querySnapshot = await getDocs(traelCollection);
        const cargas = document.getElementById("cargas-lista");
        cargas.innerHTML = "";

        querySnapshot.forEach((doc) => {
          const carga = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${carga.datanfe || ''}</td>
            <td>${carga.placa || ''}</td>
            <td>${carga.localizacao || ''}</td>
            <td>${carga.status || ''}</td>
            <td>${carga.mercadoria || ''}</td>
            <td>${carga.nfe || ''}</td>
            <td>${carga.cte || ''}</td>
            <td>${carga.previsao || ''}</td>
            <td>${carga.telefone || ''}</td>
            <td>${carga.nome || ''}</td>
            <td>${carga.comentario || ''}</td>            
            <td>
              <button class="btn-edit" onclick="editarCarga('${doc.id}')">Editar</button>
              <button class="btn-delete" onclick="excluirCarga('${doc.id}')">Excluir</button>
            </td>
          `;
          cargas.appendChild(tr);
        });
      } catch (error) {
        console.error("Erro ao carregar cargas: ", error);
        alert("Erro ao carregar cargas");
      }
    }

    window.editarCarga = (id) => {
      window.location.href = `cadastro.html?carregamentoId=${id}`;
    }

    window.excluirCarga = async (id) => {
      if (confirm("Deseja realmente excluir esta carga?")) {
        try {
          await deleteDoc(doc(db, "trael", id));
          alert("Carga excluída com sucesso!");
          carregarCarregamentos();
        } catch (error) {
          console.error("Erro ao excluir carga: ", error);
          alert("Erro ao excluir carga");
        }
      }
    }

    window.addEventListener("load", carregarCarregamentos);

    window.captureAndShare = async () => {
  try {
    // Cria um clone da tabela original
    const originalTable = document.querySelector('table');
    const clonedTable = originalTable.cloneNode(true);

    // Configurações para ocultar colunas
    const hiddenColumns = ['Telefone', 'Motorista', 'Comentario', 'Ações'];
    const clonedThs = clonedTable.querySelectorAll('thead th');
    const clonedTrs = clonedTable.querySelectorAll('tbody tr');
    const hiddenColumnIndices = [];
    
    // Identifica colunas para ocultar
    clonedThs.forEach((th, index) => {
      if (hiddenColumns.includes(th.textContent.trim())) {
        hiddenColumnIndices.push(index);
        th.style.display = 'none';
      }
    });

    // Oculta células nas linhas
    clonedTrs.forEach(tr => {
      hiddenColumnIndices.forEach(index => {
        if (tr.cells[index]) {
          tr.cells[index].style.display = 'none';
        }
      });
    });

    // Posiciona o clone fora da tela
    clonedTable.style.position = 'absolute';
    clonedTable.style.left = '-9999px';
    document.body.appendChild(clonedTable);

    // Captura a imagem do clone
    const canvas = await html2canvas(clonedTable);
    document.body.removeChild(clonedTable);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const file = new File([blob], 'monitoramento_cargas.png', { type: 'image/png' });

    // Verifica se o navegador suporta o Web Share API
    if (navigator.share) {
      try {
        await navigator.share({
          files: [file],
          title: 'Monitoramento de Cargas',
          text: 'Relatório de Monitoramento de Cargas'
        });
      } catch (error) {
        // Se der erro na API de compartilhamento, usa o fallback do WhatsApp Web
        shareViaWhatsApp(canvas.toDataURL());
      }
    } else {
      // Fallback para WhatsApp Web direto
      shareViaWhatsApp(canvas.toDataURL());
    }

    // Adiciona a funcionalidade de download
    downloadImage(blob, 'monitoramento_cargas.png');
  } catch (error) {
    console.error('Erro ao capturar ou compartilhar:', error);
    alert('Erro ao compartilhar ou baixar a imagem');
  }
};

function shareViaWhatsApp(imageData) {
  const imageDataWithoutHeader = imageData.replace('data:image/png;base64,', '');
  const text = 'Relatório de Monitoramento de Cargas';
  const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(text)}`;
  window.open(whatsappUrl, '_blank');
}

// Função para baixar a imagem
function downloadImage(blob, fileName) {
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  link.click();
  URL.revokeObjectURL(link.href); // Libera a memória após o download
}

  </script>

  <script src="../../menu.js"></script>
</body>
</html>
